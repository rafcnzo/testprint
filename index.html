<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Print JSPM v8 - POS Restoran</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .box { border: 1px solid #ccc; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .status { font-weight: bold; margin-bottom: 10px; }
        .connected { color: green; }
        .disconnected { color: red; }
        button { padding: 10px 20px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; }
        button:disabled { background-color: #ccc; }
        select { padding: 8px; width: 100%; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2>üõ†Ô∏è Test JSPrintManager v8 (POS Mini)</h2>
    
    <div class="box">
        <div class="status">
            Status JSPM Client: <span id="jspm-status" class="disconnected">Mencari Client App...</span>
        </div>
        <small>Pastikan aplikasi JSPrintManager Client sudah berjalan di komputer ini.</small>
    </div>

    <div class="box">
        <label>Pilih Printer:</label>
        <select id="printer-list" disabled>
            <option>Menunggu koneksi...</option>
        </select>
        
        <br><br>
        <button id="btn-print" onclick="doPrint()" disabled>üñ®Ô∏è Test Print Struk</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bluebird/3.3.5/bluebird.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    
    <script src="https://jsprintmanager.azurewebsites.net/scripts/JSPrintManager.js"></script>

    <script>
        // 1. Setup WebSocket & Status
        var clientPrinters = null;
        
        // Cek status koneksi WebSocket ke JSPM Client App
        JSPM.JSPrintManager.auto_reconnect = true;
        JSPM.JSPrintManager.start();
        
        JSPM.JSPrintManager.WS.onStatusChanged = function () {
            if (jspmWSStatus()) {
                // Koneksi Berhasil
                document.getElementById('jspm-status').innerText = "TERHUBUNG (Connected)";
                document.getElementById('jspm-status').className = "connected";
                
                // Ambil daftar printer
                getPrinters();
            } else {
                // Koneksi Gagal
                document.getElementById('jspm-status').innerText = "TIDAK TERHUBUNG (Pastikan App JSPM Client berjalan!)";
                document.getElementById('jspm-status').className = "disconnected";
            }
        };

        // Fungsi Cek Status
        function jspmWSStatus() {
            if (JSPM.JSPrintManager.websocket_status == JSPM.WSStatus.Open)
                return true;
            else if (JSPM.JSPrintManager.websocket_status == JSPM.WSStatus.Closed) {
                console.warn('JSPM Client tidak ditemukan atau tertutup.');
                return false;
            }
            else if (JSPM.JSPrintManager.websocket_status == JSPM.WSStatus.Blocked) {
                alert('JSPM Client memblokir website ini. Cek pengaturan whitelist di aplikasi JSPM Client.');
                return false;
            }
        }

        // 2. Mendapatkan Daftar Printer
        function getPrinters() {
            JSPM.JSPrintManager.getPrinters().then(function (printers) {
                clientPrinters = printers;
                var options = '';
                for (var i = 0; i < clientPrinters.length; i++) {
                    options += '<option value="' + clientPrinters[i] + '">' + clientPrinters[i] + '</option>';
                }
                document.getElementById('printer-list').innerHTML = options;
                document.getElementById('printer-list').disabled = false;
                document.getElementById('btn-print').disabled = false;
            });
        }

        // 3. Fungsi Print (Mengirim Raw Data / Text)
        function doPrint() {
            if (jspmWSStatus()) {
                // Membuat Print Job
                var cpj = new JSPM.ClientPrintJob();
                
                // Set Printer yang dipilih user
                cpj.clientPrinter = new JSPM.InstalledPrinter(document.getElementById('printer-list').value);

                // Contoh Isi Struk (Format Raw Text Sederhana)
                // Gunakan perintah ESC/POS (seperti \x1B\x40) jika printer thermal mendukungnya untuk formatting lebih bagus
                var strukText = "================================\n";
                strukText += "       TEST PRINT POS ERP       \n";
                strukText += "================================\n";
                strukText += "Tanggal : " + new Date().toLocaleString() + "\n";
                strukText += "Status  : OK\n";
                strukText += "Printer : " + document.getElementById('printer-list').value + "\n";
                strukText += "--------------------------------\n";
                strukText += "Terima kasih sudah berkunjung!\n";
                strukText += "\n\n\n_"; // Feed paper (spasi bawah)

                // Kirim data sebagai Raw Plain Text
                cpj.printerCommands = strukText;
                
                // Kirim ke Client
                cpj.sendToClient();
                
                alert("Perintah print dikirim!");
            }
        }
    </script>
</body>
</html>
