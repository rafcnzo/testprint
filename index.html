<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS Printer Manager</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 30px auto; background: #f0f2f5; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Tab Styling */
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; color: #777; }
        .tab.active { border-bottom: 2px solid #007bff; color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Form Elements */
        select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 5px; }
        select { border: 1px solid #ddd; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        .status { margin-bottom: 15px; font-size: 14px; text-align: center; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
        .online { background: #d4edda; color: #155724; }
        .offline { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<div class="card">
    <div class="status">
        Status Bridge: <span id="status-badge" class="badge offline">Menghubungkan...</span>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('tab-setting')">‚öôÔ∏è Pilih Printer</div>
        <div class="tab" onclick="switchTab('tab-test')">üñ®Ô∏è Test Print</div>
    </div>

    <div id="tab-setting" class="tab-content active">
        <label>Daftar Printer di Komputer Ini:</label>
        <select id="printer-select" onchange="savePrinter()">
            <option value="">-- Sedang memuat printer... --</option>
        </select>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            *Jika kosong, pastikan service .exe sudah jalan.
        </p>
        <button onclick="loadPrinters()">üîÑ Refresh Daftar Printer</button>
    </div>

    <div id="tab-test" class="tab-content">
        <div style="background: #eee; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <strong>Printer Terpilih:</strong><br>
            <span id="selected-printer-display" style="color: #007bff;">Belum dipilih</span>
        </div>
        <button id="btn-print" onclick="testPrint()" disabled>Kirim Test Print</button>
    </div>
</div>

<script>
    const API_URL = 'http://localhost:3000';
    let currentPrinter = localStorage.getItem('pos_printer_name') || '';

    // 1. Fungsi Ganti Tab
    function switchTab(tabId) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // Aktifkan yg diklik (Logic sederhana via index/text matching untuk demo ini)
        if(tabId === 'tab-setting') document.querySelectorAll('.tab')[0].classList.add('active');
        if(tabId === 'tab-test') document.querySelectorAll('.tab')[1].classList.add('active');
        
        document.getElementById(tabId).classList.add('active');
        updateDisplay();
    }

    // 2. Cek Koneksi & Load Printer
    async function loadPrinters() {
        const select = document.getElementById('printer-select');
        const badge = document.getElementById('status-badge');

        try {
            // Cek status
            let res = await fetch(`${API_URL}/`);
            if(res.ok) {
                badge.innerText = "ONLINE"; 
                badge.className = "badge online";
            }

            // Ambil List Printer
            select.innerHTML = '<option>Memuat...</option>';
            let listRes = await fetch(`${API_URL}/printers`);
            let printers = await listRes.json();

            select.innerHTML = '<option value="">-- Pilih Printer --</option>';
            printers.forEach(p => {
                let opt = document.createElement('option');
                opt.value = p;
                opt.text = p;
                if(p === currentPrinter) opt.selected = true; // Auto select yg tersimpan
                select.appendChild(opt);
            });
            
            savePrinter(); // Update state

        } catch (e) {
            badge.innerText = "OFFLINE / ERROR";
            badge.className = "badge offline";
            select.innerHTML = '<option>Gagal koneksi ke Service</option>';
        }
    }

    // 3. Simpan Pilihan User
    function savePrinter() {
        const select = document.getElementById('printer-select');
        currentPrinter = select.value;
        localStorage.setItem('pos_printer_name', currentPrinter); // Simpan di browser
        updateDisplay();
    }

    function updateDisplay() {
        const display = document.getElementById('selected-printer-display');
        const btn = document.getElementById('btn-print');
        
        if(currentPrinter) {
            display.innerText = currentPrinter;
            btn.disabled = false;
        } else {
            display.innerText = "Belum dipilih (Buka Tab Setting)";
            btn.disabled = true;
        }
    }

    // 4. Test Print Logic
    async function testPrint() {
        if(!currentPrinter) return alert("Pilih printer dulu di tab sebelah!");

        const btn = document.getElementById('btn-print');
        btn.disabled = true;
        btn.innerText = "Mengirim...";

        try {
            const res = await fetch(`${API_URL}/print`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    printerName: currentPrinter,
                    data: [
                        // Contoh Item Belanja (Otomatis dilayout 2 baris biar muat 58mm)
                        { name: "Nasi Goreng Spesial", qty: 2, price: "15.000", total: "30.000" },
                        { name: "Es Teh Manis", qty: 1, price: "5.000", total: "5.000" },
                        { name: "Ayam Bakar Madu", qty: 1, price: "20.000", total: "20.000" },
                        
                        // Contoh Text Manual (buat Total / Footer tambahan)
                        { text: "--------------------------------", align: "CENTER" },
                        { text: "TOTAL: Rp 55.000", align: "RIGHT" } // Total ditaruh kanan
                    ]
                })
            });

            const json = await res.json();
            if(json.status === 'success') alert("‚úÖ Print Berhasil!");
            else alert("‚ùå Print Gagal: " + json.message);

        } catch (e) {
            alert("‚ö†Ô∏è Error Koneksi ke Service");
        } finally {
            btn.disabled = false;
            btn.innerText = "Kirim Test Print";
        }
    }

    // Init saat load
    loadPrinters();

</script>
</body>
</html>
